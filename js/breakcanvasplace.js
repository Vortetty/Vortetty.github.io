"use strict";var size,SignInDialogController=DialogController($("#sign-in-dialog")),ChangelogDialogController=DialogController($("#changelog-dialog")),HelpDialogController=DialogController($("#help-dialog")),BetaDialogController=DialogController($("#beta-dialog"));BetaDialogController.dialog.find("#signup").click(function(){placeAjax.post("/api/beta-signup",null,null).then(function(t){if(t.success)return BetaDialogController.hide();BetaDialogController.showErrorOnTab("enroll","An error occured whilst signing you up for the beta program.")}).catch(function(t){BetaDialogController.showErrorOnTab("enroll","An error occured whilst signing you up for the beta program.")})}),ChangelogDialogController.dialog.find("#changelog-opt-out").click(function(){placeAjax.delete("/api/changelog/missed")});var canvasController={isDisplayDirty:!1,init:function(t){this.canvas=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1},clearCanvas:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isDisplayDirty=!0},drawImage:function(t){this.ctx.drawImage(t,0,0,this.canvas.width,this.canvas.height),this.isDisplayDirty=!0},drawImageData:function(t){this.ctx.putImageData(t,0,0),this.isDisplayDirty=!0},setPixel:function(t,e,i){this.ctx.fillStyle=t,this.ctx.fillRect(e,i,1,1),this.isDisplayDirty=!0},getPixelColour:function(t,e){function i(t){var e=t.toString(16);return 1==e.length?"0"+e:e}var o=this.ctx.getImageData(t,e,1,1).data;return i(o[0])+i(o[1])+i(o[2])}},notificationHandler={notificationsSupported:"Notification"in window,supportsNewNotificationAPI:!1,setup:function(){navigator.serviceWorker&&(navigator.serviceWorker.register("/js/build/sw.js"),this.supportsNewNotificationAPI=!0)},canNotify:function(){return!!this.notificationsSupported&&"granted"==Notification.permission},isAbleToRequestPermission:function(){return!!this.notificationsSupported&&("denied"!==Notification.permission||"default"===Notification.permission)},requestPermission:function(t){if(!this.isAbleToRequestPermission||!this.notificationsSupported)return t(!1);Notification.requestPermission(function(e){t("granted"===e)})},sendNotification:function(t,e){var i=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.notificationsSupported){var a=this.canNotify;if(a||o){if(!a)return this.requestPermission(function(t){t&&i.sendNotification(e,o)});try{new Notification(t,{body:e}).addEventListener("click",function(t){parent.focus(),window.focus(),t.target.close()})}catch(t){console.error("Tried to send notification via old API, but failed: "+t)}}}}},place={zooming:{zoomedIn:!1,panFromX:0,panFromY:0,panToX:null,panToY:null,zooming:!1,zoomFrom:0,zoomTo:0,zoomTime:0,zoomHandle:null,fastZoom:!1,initialZoomPoint:4,zoomedInPoint:40,snapPoints:[0,4,40,80],zoomScale:4,wasZoomedFullyOut:!1},keys:{left:[37,65],up:[38,87],right:[39,68],down:[40,83]},keyStates:{},zoomButton:null,dragStart:null,placing:!1,shouldShowPopover:!1,panX:0,panY:0,selectedColour:null,handElement:null,unlockTime:null,fullUnlockTime:null,secondTimer:null,lastUpdatedCoordinates:{x:null,y:null},loadedImage:!1,notificationHandler:notificationHandler,hashHandler:hashHandler,messages:null,isOutdated:!1,lastPixelUpdate:null,colours:null,pixelFlags:null,canPlaceCustomColours:!1,hasTriedToFetchAvailability:!1,customColour:null,cursorX:0,cursorY:0,templatesEnabled:!1,socket:new PlaceSocket("client"),stat:function(){this.socket.emit("stat")},start:function(t,e,i,o,a,n,s,l,r,c){var h=this;size=t.height,$(i).css({height:size+"px",width:size+"px"}),this.canvas=t,this.canvasController=canvasController,this.canvasController.init(t),this.grid=c,this.displayCanvas=o,this.originalTitle=document.title,this.coordinateElement=n,this.userCountElement=s,this.gridHint=l,this.pixelDataPopover=r,this.notificationHandler.setup(),this.colourPaletteElement=a,this.setupColours(),this.placingOverlay=$(this.colourPaletteElement).find("#placing-modal"),this.placeTimer=$(this.colourPaletteElement).find("#place-timer"),$(this.placeTimer).on("click","#notify-me",function(){return h.handleNotifyMeClick()});var d=this;$(this.colourPaletteElement).on("click",".colour-option",function(){var t=parseInt($(this).data("colour"));t&&d.selectColour(t)}),$(this.colourPaletteElement).click(function(t){t.target===this&&d.deselectColour()}),this.updatePlaceTimer(),$("#palette-expando").click(this.handlePaletteExpandoClick),$(e).parent()[0],t.onmousemove=function(t){return h.handleMouseMove(t||window.event)},t.addEventListener("contextmenu",function(t){return h.contextMenu(t)});var u=function(t){var e=t.keyCode||t.which;d.keyStates[e]="keydown"==t.type};document.body.onkeyup=function(t){"input"!=document.activeElement.tagName.toLowerCase()&&u(t)},document.body.onkeydown=function(t){d.stat(),"input"!=document.activeElement.tagName.toLowerCase()&&$(".dialog-ctn.show").length<=0&&(u(t),d.handleKeyDown(t.keyCode||t.which))},document.body.onmousemove=function(t){d.stat(),d.cursorX=t.pageX,d.cursorY=t.pageY},window.onresize=function(){return h.handleResize()},window.onhashchange=function(){return h.handleHashChange()},$(window).on("wheel mousewheel",function(t){return h.mousewheelMoved(t)}),this.zoomController=e,this.cameraController=i,this.setupDisplayCanvas(this.displayCanvas),this.setupInteraction();var p=this.getSpawnPoint();this.setCanvasPosition(p.x,p.y),this.setupZoomSlider(),this.setZoomScale(this.zooming.zoomScale),$(this.coordinateElement).show(),$(this.userCountElement).show(),this.getCanvasImage(),this.determineFeatureAvailability(),this.initializeSocketConnection(),this.changeUserCount(null),this.loadUserCount().then(function(t){h.userCountChanged(t)}).catch(function(t){return $(h.userCountElement).hide()}),this.popoutController=popoutController,this.popoutController.setup(this,$("#popout-container")[0]),this.popoutController.popoutVisibilityController.visibilityChangeCallback=function(){var t=new Date,e=setInterval(function(){d.handleResize(),new Date-t>250&&clearInterval(e)},1)},$("#colour-picker").minicolors({inline:!0,format:"hex",letterCase:"uppercase",defaultValue:"#D66668",change:function(t){return h.handleColourPaletteChange(t)}}),$("#colour-picker-hex-value").on("input change keydown",function(t){t.keyCode&&33!==t.keyCode||d.handleColourTextChange("input"===t.type)}),$(".canvas-container").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){h.handleResize()}),this.updateColourSelectorPosition(),$("#colour-picker-popover-ctn").click(function(){$("body").removeClass("picker-showing")}),$("#pixel-use-colour-btn").click(function(){var t=$(this).attr("data-represented-colour");$("#colour-picker").minicolors("value","#"+t)}),setInterval(function(){d.doKeys()},15),this.dismissBtn=$("<button>").attr("type","button").addClass("close").attr("data-dismiss","alert").attr("aria-label","Close"),$("<span>").attr("aria-hidden","true").html("&times;").appendTo(this.dismissBtn),this.loadWarps(),this.layoutTemplates()},handleColourTextChange:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=$("#colour-picker-hex-value").val();"#"!=e.substring(0,1)&&(e="#"+e),(7==e.length||4==e.length&&!t)&&$("#colour-picker").minicolors("value",e)},determineFeatureAvailability:function(){var t=this;placeAjax.get("/api/feature-availability",null,null).then(function(e){t.hasTriedToFetchAvailability=!0,t.colours=e.availability.colours,t.pixelFlags=e.availability.flags,t.canPlaceCustomColours=e.availability.user&&e.availability.user.canPlaceCustomColours,t.templatesEnabled=e.availability.user&&e.availability.user.hasTemplatesExperiment,t.layoutTemplates(),t.setupColours()}).catch(function(e){t.hasTriedToFetchAvailability=!0,setTimeout(function(){return t.determineFeatureAvailability()},2500),t.setupColours()})},getCanvasImage:function(){if(!this.loadedImage){var t=this;this.adjustLoadingScreen("Loading…"),this.loadImage().then(function(e){t.adjustLoadingScreen(),t.canvasController.clearCanvas(),t.canvasController.drawImage(e),t.updateDisplayCanvas(),t.displayCtx.imageSmoothingEnabled=!1,t.loadedImage=!0,t.lastPixelUpdate=Date.now()/1e3}).catch(function(e){console.error("Error loading board image",e),void 0!==e.status&&503===e.status?(t.adjustLoadingScreen("Waiting for server…"),console.log("Server wants us to await its instruction"),setTimeout(function(){t.getCanvasImage()},15e3)):(t.adjustLoadingScreen("An error occurred. Please wait…"),setTimeout(function(){t.getCanvasImage()},5e3))})}},loadImage:function(){var t=this;return new Promise(function(e,i){var o=new XMLHttpRequest;o.open("GET","/api/board-image",!0),o.responseType="blob",o.onload=function(a){if(200==o.status){var n=URL.createObjectURL(this.response),s=new Image;s.onload=function(){URL.revokeObjectURL(this.src);var i=o.getResponseHeader("X-Place-Last-Update");i&&t.requestPixelsAfterDate(i),e(s)},s.onerror=function(){return i(o)},s.src=n}else i(o)},o.onerror=function(){return i(o)},o.send()})},neededPixelDate:null,requestPixelsAfterDate:function(t){console.log("Requesting pixels after date "+t),this.socket.send("fetch_pixels",{ts:t})},setupInteraction:function(){var t=this,e=this;interact(this.cameraController).draggable({inertia:!0,restrict:{restriction:"parent",elementRect:{top:.5,left:.5,bottom:.5,right:.5},endOnly:!0},autoScroll:!0,onstart:function(t){if(2==t.interaction.downEvent.button)return t.preventDefault();e.stat(),$(e.zoomController).addClass("grabbing"),$(":focus").blur()},onmove:function(t){e.moveCamera(t.dx,t.dy),e.stat()},onend:function(t){if(2==t.interaction.downEvent.button)return t.preventDefault();e.stat(),$(e.zoomController).removeClass("grabbing");var i=e.getCoordinates();e.hashHandler.modifyHash(i)}}).on("tap",function(i){if(2==i.interaction.downEvent.button)return i.preventDefault();if(!t.zooming.zooming){var o=e.getCanvasCursorPosition(i.pageX,i.pageY);e.canvasClicked(o.x,o.y)}i.preventDefault()}).on("doubletap",function(i){e.zooming.zoomedIn&&null===t.selectedColour&&(e.zoomFinished(),e.shouldShowPopover=!1,e.setZoomScale(t.zooming.initialZoomPoint,!0),i.preventDefault())})},mousewheelMoved:function(t){if(!($(".canvas-container:hover").length<=0)){var e=t.originalEvent;e.preventDefault();var i="wheel"==e.type?-e.deltaY:void 0!==e.wheelDeltaY?e.wheelDeltaY:e.wheelDelta;this.setZoomScale(this.zooming.zoomScale+i/100)}},getCanvasCursorPosition:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this._getZoomMultiplier();return{x:Math.round(((t||this.cursorX)-$(this.cameraController).offset().left)/i),y:Math.round(((e||this.cursorY)-$(this.cameraController).offset().top)/i)}},loadUserCount:function(){return new Promise(function(t,e){placeAjax.get("/api/online").then(function(i){if(!i.online)return e();t(i.online.count)}).catch(function(t){return e(t)})})},getSpawnPoint:function(){return this.getHashPoint()||this.getRandomSpawnPoint()},getHashPoint:function(){var t=this.hashHandler.getHash();if(void 0!==t.x&&void 0!==t.y){var e=parseInt(t.x),i=parseInt(t.y),o=this.closestInsideCoordinates(e,i);if(null!==e&&null!==i&&!isNaN(e)&&!isNaN(i))return{x:-o.x+size/2,y:-o.y+size/2}}return null},handleHashChange:function(){var t=this.getHashPoint();t&&this.setCanvasPosition(t.x,t.y)},initializeSocketConnection:function(){var t=this;this.socket.on("open",function(){t.isOutdated&&(Date.now()/1e3-t.lastPixelUpdate>60?(console.log("We'll need to get the entire board image because the last update was over a minute ago."),t.loadedImage=!1,t.getCanvasImage(),t.isOutdated=!1):(console.log("The last request was a minute or less ago, we can just get the changed pixels over websocket."),t.requestPixelsAfterDate(t.lastPixelUpdate)))}),this.socket.on("close",function(){t.isOutdated=!0});var e={tile_placed:this.liveUpdateTile.bind(this),tiles_placed:this.liveUpdateTiles.bind(this),server_ready:this.getCanvasImage.bind(this),user_change:this.userCountChanged.bind(this),admin_broadcast:this.adminBroadcastReceived.bind(this),reload_client:function(){return window.location.reload()}};Object.keys(e).forEach(function(i){t.socket.on(i,e[i])})},get isAFK(){return!(this._stat>Date.now()-1e3*this.activityTimeout)},getRandomSpawnPoint:function(){function t(){return Math.random()*size-size/2}return{x:t(),y:t()}},liveUpdateTiles:function(t){var e=this;t.pixels&&t.pixels.forEach(function(t){return e.liveUpdateTile(t)})},liveUpdateTile:function(t){this.lastPixelUpdate=Date.now()/1e3,this.setPixel("#"+t.colour,t.x,t.y)},adminBroadcastReceived:function(t){this.showAdminBroadcast(t.title,t.message,t.style||"info",t.timeout||0)},userCountChanged:function(t){null!==t&&this.changeUserCount(t)},setupColours:function(){var t=this,e=$("#availability-loading-modal");$(this.colourPaletteElement).find(".colour-option, .palette-separator").remove();var i=$(this.colourPaletteElement).find("#palette-content-ctn");if(this.colourPaletteOptionElements=[],this.colours){e.hide(),this.canPlaceCustomColours&&$("<div>").addClass("colour-option rainbow").attr("id","customColourChooserOption").click(function(){$("body").toggleClass("picker-showing"),$("body").hasClass("picker-showing")&&$("#colour-picker-hex-value").focus()}).append('<div class="colour-option transparent"></div>').appendTo(i);var o=$("<div>").addClass("colour-option custom").attr("id","customChosenColourOption").attr("data-colour",1).hide().appendTo(i);this.colourPaletteOptionElements.push(o[0]),this.canPlaceCustomColours&&$("<div>").addClass("palette-separator").appendTo(i),this.colours.forEach(function(e,o){var a=$("<div>").addClass("colour-option"+("#ffffff"==e.toLowerCase()?" is-white":"")).css("background-color",e).attr("data-colour",o+2);a.appendTo(i),t.colourPaletteOptionElements.push(a[0])}),this.updateColourSelectorPosition(),this.pixelFlags&&this.pixelFlags.length>0&&($("<div>").addClass("palette-separator").appendTo(i),this.pixelFlags.forEach(function(e,o){var a=$("<div>").addClass("colour-option flag-option").css("background-image","url("+e.image+")").attr("data-flag",o).attr("data-flag-id",e.id).attr("title",e.title+":\n"+e.description).attr("alt",e.title);e.needsBorder&&a.addClass("is-white"),a.appendTo(i),t.colourPaletteOptionElements.push(a[0])}))}else e.text(this.hasTriedToFetchAvailability?"An error occurred while loading colours. Retrying…":"Loading…").show()},handleColourPaletteChange:function(t){if(this.canPlaceCustomColours){this.customColour=t;var e=$("#customChosenColourOption").show().css("background-color",t);$("#colour-picker-hex-value").val(t.toUpperCase()),"#ffffff"==t.toLowerCase()?e.addClass("is-white"):e.removeClass("is-white"),this.selectColour(1,!1)}},handleResize:function(){var t=$(this.zoomController).parent();this.displayCanvas.height=t.height(),this.displayCanvas.width=t.width(),this.displayCtx.mozImageSmoothingEnabled=!1,this.displayCtx.webkitImageSmoothingEnabled=!1,this.displayCtx.msImageSmoothingEnabled=!1,this.displayCtx.imageSmoothingEnabled=!1,this.updateDisplayCanvas(),this.zooming.wasZoomedFullyOut&&this.setZoomScale(0),this.updateGrid(),this.updateGridHint(this.lastX,this.lastY),this.updateColourSelectorPosition()},updateColourSelectorPosition:function(){var t=$("#colour-picker-popover"),e=$("#customColourChooserOption"),i=20;if(e.length>0&&(i=Math.max(20,e.offset().left-t.outerWidth()/2+e.outerWidth()/2)),i<=20)if(t.addClass("arrow-left"),e.length>0){var o=e.offset().left-e.outerWidth()/2-10;$("#popover-styling").html("#colour-picker-popover:after, #colour-picker-popover:before { left: "+o+"px!important; }")}else $("#popover-styling").html("");else t.removeClass("arrow-left"),$("#popover-styling").html("");t.css({left:i})},setupDisplayCanvas:function(t){this.displayCtx=t.getContext("2d"),this.handleResize(),this.updateDisplayCanvas()},updateDisplayCanvas:function(){var t=this.displayCanvas;this.displayCtx.clearRect(0,0,t.width,t.height);var e=this._getCurrentZoom(),i=size/2;this.displayCtx.drawImage(this.canvas,t.width/2+(this.panX-i-.5)*e,t.height/2+(this.panY-i-.5)*e,this.canvas.width*e,this.canvas.height*e)},_lerp:function(t,e,i){return i>100&&(i=100),t+i/100*(e-t)},_getCurrentZoom:function(){return this.zooming.zooming?this._lerp(this.zooming.zoomFrom,this.zooming.zoomTo,this.zooming.zoomTime):this._getZoomMultiplier()},_getZoomMultiplier:function(){return this.zooming.zoomScale},animateZoom:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.zooming.zoomTime+=this.zooming.fastZoom?5:2;var e=this._lerp(this.zooming.panFromX,this.zooming.panToX,this.zooming.zoomTime),i=this._lerp(this.zooming.panFromY,this.zooming.panToY,this.zooming.zoomTime);if(this.updateUIWithZoomScale(this._lerp(this.zooming.zoomFrom,this.zooming.zoomTo,this.zooming.zoomTime)),this.setCanvasPosition(e,i),this.zooming.zoomTime>=100)return this.zoomFinished(),this.shouldShowPopover&&($(this.pixelDataPopover).fadeIn(250),this.shouldShowPopover=!1),void(t&&t())},updateUIWithZoomScale:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null===t&&(t=this.zooming.zoomScale),$(this.zoomController).css("transform","scale("+t+")"),$("#zoom-slider").slider("setValue",t,!0),$(this.handElement).css({width:t+"px",height:t+"px",borderRadius:t/8+"px"}),$(this.gridHint).css({width:t+"px",height:t+"px"}),this.updateGridHint(this.lastX,this.lastY)},zoomFinished:function(){this.zooming.zoomScale=this.zooming.zoomTo,this.zooming.zooming=!1,this.setCanvasPosition(this.zooming.panToX,this.zooming.panToY),this.zooming.panToX=null,this.zooming.panToY=null,this.zooming.zoomTo=null,this.zooming.zoomFrom=null,clearInterval(this.zooming.zoomHandle);var t=this.getCoordinates();this.hashHandler.modifyHash(t),this.zooming.zoomHandle=null,this.zooming.fastZoom=!1},setupZoomSlider:function(){var t=this,e=this.getMinimumScale();$("#zoom-slider").slider({ticks:this.zooming.snapPoints.map(function(t){return Math.max(t,e)}),ticks_snap_bounds:.01,step:.01,min:e,max:this.zooming.snapPoints[this.zooming.snapPoints.length-1],scale:"logarithmic",value:this.zooming.zoomScale}).on("change",function(e){t.setZoomScale(e.value.newValue,!1,!1)})},setZoomScale:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(arguments.length>2&&void 0!==arguments[2])||arguments[2],null===this.zooming.zoomHandle){this.zooming.panFromX=this.panX,this.zooming.panFromY=this.panY,null==this.zooming.panToX&&(this.zooming.panToX=this.panX),null==this.zooming.panToY&&(this.zooming.panToY=this.panY);var i=this.normalizeZoomScale(t);e?(this.zooming.zoomTime=0,this.zooming.zoomFrom=this._getCurrentZoom(),this.zooming.zoomTo=i,this.zooming.zooming=!0,this.zooming.zoomHandle=setInterval(this.animateZoom.bind(this),1)):(this.zooming.zoomScale=i,this.updateUIWithZoomScale(i)),this.zooming.zoomedIn=i>=(this.zooming.initialZoomPoint+this.zooming.zoomedInPoint)/2,this.zooming.zoomedIn||$(this.pixelDataPopover).hide(),this.updateDisplayCanvas(),this.updateGrid(),this._adjustZoomButtonText()}},getMinimumScale:function(){var t=$(this.zoomController).parent();return Math.min(1,Math.min((t.height()-$("#page-nav").height())/size,t.width()/size))},normalizeZoomScale:function(t){var e=this.getMinimumScale(),i=Math.min(this.zooming.snapPoints[this.zooming.snapPoints.length-1],Math.max(e,Math.max(this.zooming.snapPoints[0],t)));return this.zooming.wasZoomedFullyOut=i<=e,this.zooming.wasZoomedFullyOut&&!$(this.colourPaletteElement).hasClass("full-canvas")?$(this.colourPaletteElement).addClass("full-canvas"):!this.zooming.wasZoomedFullyOut&&$(this.colourPaletteElement).hasClass("full-canvas")&&$(this.colourPaletteElement).removeClass("full-canvas"),i},toggleZoom:function(){if(!this.zooming.zooming){var t=this.zooming.zoomScale;t<this.zooming.initialZoomPoint?this.setZoomScale(this.zooming.initialZoomPoint,!0):t<(this.zooming.initialZoomPoint+this.zooming.zoomedInPoint)/2?this.setZoomScale(this.zooming.zoomedInPoint,!0):t<=this.zooming.zoomedInPoint?this.setZoomScale(this.zooming.initialZoomPoint,!0):this.setZoomScale(this.zooming.zoomedInPoint,!0)}},_adjustZoomButtonText:function(){this.zoomButton&&$(this.zoomButton).html('<i class="fa fa-fw fa-search-'+(this.zooming.zoomedIn?"minus":"plus")+'"></i>').attr("title",(this.zooming.zoomedIn?"Zoom Out":"Zoom In")+" (spacebar)")},_adjustGridButtonText:function(){var t=$(this.grid).hasClass("show");this.gridButton&&$(this.gridButton).html('<i class="fa fa-fw fa-'+(t?"square":"th")+'"></i>').attr("title",(t?"Hide Grid":"Show Grid")+" (G)")},setZoomButton:function(t){this.zoomButton=t,this._adjustZoomButtonText(),$(t).click(this.toggleZoom.bind(this))},setGridButton:function(t){this.gridButton=t,this._adjustGridButtonText(),$(t).click(this.toggleGrid.bind(this))},setCoordinatesButton:function(t){if(Clipboard.isSupported()){var e=new Clipboard(t);$(t).addClass("clickable").tooltip({title:"Copied to clipboard!",trigger:"manual"}),e.on("success",function(e){$(t).tooltip("show"),setTimeout(function(){$(t).tooltip("hide")},2500)})}},moveCamera:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=($(this.cameraController),this._getCurrentZoom()),a=(this.getCoordinates(),t/o),n=e/o;this.setCanvasPosition(a,n,!0,i)},updateCoordinates:function(){var t=this.getCoordinates();if(t!=this.lastUpdatedCoordinates){var e=$(this.coordinateElement);setTimeout(function(){var i=e.find("span");i.first().text(t.x.toLocaleString()),i.last().text(t.y.toLocaleString()),e.attr("data-clipboard-text","("+t.x+", "+t.y+")")},0)}this.lastUpdatedCoordinates=t},isOutsideOfBounds:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this.getCoordinates(),i=e.x<0||e.x>=size,o=e.y>=size||e.y<0;return t?{x:i,y:o}:i||o},getCoordinates:function(){var t=this.canvasController.canvas;return{x:Math.floor(-this.panX)+t.width/2,y:Math.floor(-this.panY)+t.height/2}},setCanvasPosition:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];$(this.pixelDataPopover).hide(),i?(this.panX+=t,this.panY+=e):(this.panX=t,this.panY=e),o||(this.panX=Math.max(-size/2+1,Math.min(size/2,this.panX)),this.panY=Math.max(-size/2+1,Math.min(size/2,this.panY))),$(this.cameraController).css({top:this.panY+"px",left:this.panX+"px"}),this.updateGrid(),this.lastX,this.lastY&&this.updateGridHint(this.lastX,this.lastY),this.updateCoordinates(),this.updateDisplayCanvas()},updateGrid:function(){var t=this._getCurrentZoom(),e=($(this.cameraController).offset().left-t/2)%t,i=($(this.cameraController).offset().top-t/2)%t;$(this.grid).css({transform:"translate("+e+"px, "+i+"px)",backgroundSize:t+"px "+t+"px"})},toggleGrid:function(){$(this.grid).toggleClass("show"),this._adjustGridButtonText()},updateGridHint:function(t,e){if(this.lastX=t,this.lastY=e,this.gridHint){var i=this._getCurrentZoom(),o=(t=Math.round((this.lastX-$(this.cameraController).offset().left)/i),e=Math.round((this.lastY-$(this.cameraController).offset().top)/i),$(this.gridHint)),a=t+$(this.cameraController).offset().left/i-.5,n=e+$(this.cameraController).offset().top/i-.5;o.css({left:a*i,top:n*i})}},handleMouseMove:function(t){if(!this.placing&&(this.updateGridHint(t.pageX,t.pageY),this.handElement)){var e=$(this.handElement);e.css({left:t.pageX-e.width()/2,top:t.pageY-e.height()/2})}},closestInsideCoordinates:function(t,e){return{x:Math.max(0,Math.min(t,size-1)),y:Math.max(0,Math.min(e,size-1))}},contextMenu:function(t){if(t.preventDefault(),null!==this.selectedColour)return this.deselectColour();this.setZoomScale(this.zooming.initialZoomPoint,!0)},getPixel:function(t,e,i){return placeAjax.get("/api/pos-info",{x:t,y:e},"An error occurred while trying to retrieve data about that pixel.").then(function(t){i(null,t)}).catch(function(t){return i(t)})},isSignedIn:function(){return $("body").hasClass("signed-in")},updatePlaceTimer:function(){var t=this;if(this.isSignedIn()){this.changePlaceTimerVisibility(!0),$(this.placeTimer).children("span").text("Loading…");var e=this;return placeAjax.get("/api/timer").then(function(t){return e.doTimer(t.timer)}).catch(function(e){return t.changePlaceTimerVisibility(!1)})}this.changePlaceTimerVisibility(!1)},doTimer:function(t){var e=this;if(this.changePlaceTimerVisibility(!0),t.canPlace)return this.changePlaceTimerVisibility(!1);this.unlockTime=(new Date).getTime()/1e3+0,this.fullUnlockTime=t.seconds,this.secondTimer=setInterval(function(){return e.checkSecondsTimer()},1e3),this.checkSecondsTimer()},getSiteName:function(){return $("meta[name=place-site-name]").attr("content")},checkSecondsTimer:function(){if(this.unlockTime&&this.secondTimer&&this.fullUnlockTime){var t=Math.round(this.unlockTime-(new Date).getTime()/1e3);if(t>0){var e=~~(t/60),i=e+":"+function(t,e,i){return t.length>2?t:(new Array(3).join("0")+t).slice(-2)}((t-60*e).toString());document.title="["+i+"] | "+this.originalTitle;var o=!this.notificationHandler.canNotify()&&this.notificationHandler.isAbleToRequestPermission();return void $(this.placeTimer).children("span").html("You may place again in <strong>"+i+"</strong>."+(o?' <a href="#" id="notify-me">Notify me</a>.':""))}this.fullUnlockTime>5&&this.notificationHandler.sendNotification(this.getSiteName(),"You may now place!")}this.secondTimer&&clearInterval(this.secondTimer),this.secondTimer=null,this.unlockTime=null,this.fullUnlockTime=null,document.title=this.originalTitle,this.changePlaceTimerVisibility(!1)},handleNotifyMeClick:function(){var t=this;if(!this.notificationHandler.canNotify()&&this.notificationHandler.isAbleToRequestPermission())return this.notificationHandler.requestPermission(function(e){return t.checkSecondsTimer()});this.checkSecondsTimer()},changeUserCount:function(t){var e=$(this.userCountElement);e.show();var i=e.find(".loading"),o=e.find(".count"),a=parseInt(t);null===a||isNaN(a)?(i.show(),o.text("")):(i.hide(),o.text(a.toLocaleString()))},changePlaceTimerVisibility:function(t){t?$(this.placeTimer).addClass("shown"):$(this.placeTimer).removeClass("shown"),this.changeSelectorVisibility(!t)},changePlacingModalVisibility:function(t){t?$(this.placingOverlay).addClass("shown"):$(this.placingOverlay).removeClass("shown")},selectColour:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.deselectColour(e),this.selectedColour=t-1;var i=this.colourPaletteOptionElements[this.selectedColour];this.handElement=$(i).clone().addClass("hand").appendTo($(this.zoomController).parent())[0],this.updateUIWithZoomScale(),$(i).addClass("selected"),$(this.zoomController).addClass("selected"),$(this.gridHint).show(),this.lastX&&this.lastY&&this.updateGridHint(this.lastX,this.lastY)},deselectColour:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.selectedColour=null,t&&$("body").removeClass("picker-showing"),$(this.handElement).remove(),$(this.colourPaletteOptionElements).removeClass("selected"),$(this.zoomController).removeClass("selected"),$(this.gridHint).hide()},changeSelectorVisibility:function(t){null!=this.selectedColour&&(t?(this.colourPaletteOptionElements[this.selectedColour],$(this.handElement).show(),$(this.zoomController).addClass("selected"),$(this.gridHint).show()):($(this.handElement).hide(),$(this.zoomController).removeClass("selected"),$(this.gridHint).hide()))},zoomIntoPoint:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.zooming.panToX=-(t-size/2),this.zooming.panToY=-(e-size/2),this.zooming.panFromX=this.panX,this.zooming.panFromY=this.panY,this.setZoomScale(i&&!this.zooming.zoomedIn?40:this.zooming.zoomScale,!0)},canvasClicked:function(t,e,i){function o(t,e){var i=$("<div>").addClass("field");return $("<span>").addClass("title").text(t).appendTo(i),$("<span>").addClass("value").html(e).appendTo(i),i}function a(t,e){var i=o(t,"");return $("<time>").attr("datetime",e).attr("title",new Date(e).toLocaleString()).text($.timeago(e)).prependTo(i.find(".value")),i}var n=this,s=this;if(this.stat(),$(this.pixelDataPopover).hide(),!(t<0||e<0||t>this.canvas.width-1||e>this.canvas.height-1)){var l=!this.zooming.zoomedIn;if(l&&this.zoomIntoPoint(t,e),null===this.selectedColour)return this.zoomIntoPoint(t,e),this.getPixel(t,e,function(i,l){if(!i&&l.pixel){var r=$(n.pixelDataPopover);n.zooming.zooming?n.shouldShowPopover=!0:r.fadeIn(250);var c=!!l.pixel.user;if(void 0===l.pixel.userError&&(l.pixel.userError=null),r.find("#pixel-data-username").text(c?l.pixel.user.username:n.getUserStateText(l.pixel.userError)),c?r.find("#pixel-data-username").removeClass("deleted-account"):r.find("#pixel-data-username").addClass("deleted-account"),r.find("#pixel-data-time").text($.timeago(l.pixel.modified)),r.find("#pixel-data-time").attr("datetime",l.pixel.modified),r.find("#pixel-data-time").attr("title",new Date(l.pixel.modified).toLocaleString()),r.find("#pixel-data-x").text(t.toLocaleString()),r.find("#pixel-data-y").text(e.toLocaleString()),r.find("#pixel-colour-code").text("#"+l.pixel.colour.toUpperCase()),r.find("#pixel-colour-preview").css("background-color","#"+l.pixel.colour),"ffffff"==l.pixel.colour.toLowerCase()?r.find("#pixel-colour-preview").addClass("is-white"):r.find("#pixel-colour-preview").removeClass("is-white"),r.find("#pixel-use-colour-btn").attr("data-represented-colour",l.pixel.colour),n.canPlaceCustomColours?r.find(".pixel-colour").addClass("allow-use"):r.find(".pixel-colour").removeClass("allow-use"),r.find(".rank-container > *").remove(),c){var h=r.find(".user-info");h.show(),h.find(".field").remove(),o("Total pixels placed",l.pixel.user.statistics.totalPlaces.toLocaleString()).appendTo(h),null!==l.pixel.user.statistics.placesThisWeek&&o("Pixels this week",l.pixel.user.statistics.placesThisWeek.toLocaleString()).appendTo(h),a("Account created",l.pixel.user.creationDate).appendTo(h);var d=a("Last placed",l.pixel.user.statistics.lastPlace).appendTo(h);if(l.pixel.user.latestPixel&&l.pixel.user.latestPixel.isLatest){var u=l.pixel.user.latestPixel,p=$("<div>");l.pixel.point.x==u.point.x&&l.pixel.point.y==u.point.y?$("<span>").addClass("secondary-info").text("(this pixel)").appendTo(p):$("<a>").attr("href","javascript:void(0)").text("at ("+u.point.x.toLocaleString()+", "+u.point.y.toLocaleString()+")").click(function(){return s.zoomIntoPoint(u.point.x,u.point.y,!1)}).appendTo(p),p.appendTo(d.find(".value"))}r.find("#pixel-data-username").attr("href","/@"+l.pixel.user.username);var m=r.find(".rank-container");l.pixel.user.badges.forEach(function(t){return renderBadge(t).appendTo(m)}),r.find("#user-actions-dropdown-ctn").html(renderUserActionsDropdown(l.pixel.user))}else r.find(".user-info, #pixel-badge, #pixel-user-state-badge").hide(),r.find("#user-actions-dropdown-ctn").html(""),r.find("#pixel-data-username").removeAttr("href")}});if(!l&&null!==this.selectedColour&&!this.placing){this.changePlacingModalVisibility(!0);var r=this.getCurrentColourHex();this.placing=!0,placeAjax.post("/api/place",{x:t,y:e,hex:r},"An error occurred while trying to place your pixel.",function(){n.changePlacingModalVisibility(!1),n.placing=!1}).then(function(i){n.popoutController.loadActiveUsers(),n.setPixel(r,t,e),n.changeSelectorVisibility(!1),i.timer?n.doTimer(i.timer):n.updatePlaceTimer()}).catch(function(){})}}},getCurrentColourHex:function(){return this.selectedColour<=0&&this.customColour?this.customColour:this.colours[this.selectedColour-1]},setPixel:function(t,e,i){this.canvasController.setPixel(t,e,i),this.updateDisplayCanvas()},doKeys:function(){var t=this,e=Object.keys(this.keys).filter(function(e){return t.keys[e].filter(function(e){return!0===t.keyStates[e]}).length>0});e.indexOf("up")>-1&&this.moveCamera(0,5,!1),e.indexOf("down")>-1&&this.moveCamera(0,-5,!1),e.indexOf("left")>-1&&this.moveCamera(5,0,!1),e.indexOf("right")>-1&&this.moveCamera(-5,0,!1)},handleKeyDown:function(t){71==t?this.toggleGrid():32==t?this.toggleZoom():27==t&&null!==this.selectedColour?this.deselectColour():80==t&&this.pickColourUnderCursor()},pickColourUnderCursor:function(){if(this.canPlaceCustomColours){var t=this.getCanvasCursorPosition(),e=this.canvasController.getPixelColour(t.x,t.y);$("#colour-picker").minicolors("value","#"+e)}},adjustLoadingScreen:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t?$("#loading").show().find(".text").text(t):$("#loading").fadeOut()},getUserStateText:function(t){return"ban"==t?"Banned user":"deactivated"==t?"Deactivated user":"Deleted account"},showAdminBroadcast:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=$("<div>").addClass("floating-alert admin-alert alert alert-block alert-dismissable").addClass("alert-"+i).hide().prependTo($("#floating-alert-ctn"));this.dismissBtn.clone().appendTo(a);var n=$("<p>").text(e).appendTo(a);null!=t&&""!=t&&($("<span>").text(" ").prependTo(n),$("<strong>").text(t).prependTo(n)),a.fadeIn(400,function(){o>0&&setTimeout(function(){a.fadeOut(400,function(){a.remove()})},1e3*o)})},handlePaletteExpandoClick:function(){var t={duration:150,queue:!1};$(this).toggleClass("expanded").hasClass("expanded")?$("#menu-content-ctn").slideDown(t):$("#menu-content-ctn").slideUp(t).fadeOut(t)},loadWarps:function(){var t=this;this.isSignedIn()&&placeAjax.get("/api/warps",null,null).then(function(e){t.warps=e.warps,t.layoutWarps()}).catch(function(e){console.error("Couldn't load warps: "+e),t.warps=null,t.layoutWarps()})},layoutWarps:function(){function t(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=$("<div>").addClass("warp-info");return t&&$("<span>").addClass("warp-title").text(t).appendTo(s),e&&$("<span>").addClass("warp-coordinates").text(e).appendTo(s),n?s.addClass("add").attr("title","Create a warp at the current position").append('<span class="warp-title"><i class="fa fa-plus"></i></span>'):("function"==typeof a&&$("<div>").addClass("warp-delete").attr("title","Delete warp '"+t+"'").html('<i class="fa fa-minus fa-fw"></i>').click(a.bind(i,s)).appendTo(s),s.attr("title","Warp to '"+t+"'")),o&&s.click(o.bind(i,s)),s}var e=this,i=this,o=$("#warps-ctn");if(!this.warps)return o.text("Couldn't load warps.");o.html("");var a=$("<div>").addClass("menu-section-content").appendTo($("<div>").addClass("menu-section-content-ctn").appendTo(o));if(t(null,null,this.addNewWarpClicked,null,!0).appendTo(a),this.warps.length>0)this.warps.forEach(function(i){return t(i.name,"("+i.location.x.toLocaleString()+", "+i.location.y.toLocaleString()+")",function(){return e.zoomIntoPoint(i.location.x,i.location.y,!1)},e.deleteWarpClicked).attr("data-warp-id",i.id).appendTo(a)});else{a.addClass("empty");var n=$("<div>").addClass("warp-info explanation").appendTo(a);$("<span>").addClass("warp-title").text("Warps").appendTo(n),$("<span>").addClass("warp-coordinates").text("Use warps to get around the canvas quickly. Save a position and warp to it later on.").appendTo(n)}},addNewWarpClicked:function(t,e){var i=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=window.prompt("Enter a title for this warp (at current position):",o||"");if(a&&!(a.length<=0)){var n=this.getCoordinates();placeAjax.post("/api/warps",{x:n.x,y:n.y,name:a},"An unknown error occurred while attempting to create your warp.").then(function(t){t.warp&&i.warps.unshift(t.warp),i.layoutWarps()}).catch(function(o){"validation"==o.code&&i.addNewWarpClicked(t,e,a)})}},deleteWarpClicked:function(t,e){function i(e){t.data("deleting",e);var i=t.find("i");e?i.addClass("fa-minus").removeClass("fa-spin fa-circle-o-notch"):i.removeClass("fa-minus").addClass("fa-spin fa-circle-o-notch")}var o=this;if(e.preventDefault(),e.stopPropagation(),!0!==t.data("deleting")&&window.confirm("Are you sure you want to delete this warp?")){i(!0);var a=t.attr("data-warp-id");a&&placeAjax.delete("/api/warps/"+a,null,"An unknown error occurred while attempting to delete the specified warp.",function(){return i(!1)}).then(function(t){var e=o.warps.map(function(t){return t.id}).indexOf(a);e>=0&&o.warps.splice(e,1),o.layoutWarps()}).catch(function(){})}},loadTemplates:function(){var t=localStorage.getItem("templates");if(!t)return this.templates=[];this.templates=JSON.parse(t)},saveTemplates:function(){localStorage.setItem("templates",JSON.stringify(this.templates||[]))},layoutTemplates:function(){var t=this;if(!this.templatesEnabled)return $("#templates-ctn").text("Coming Soon");this.templates||this.loadTemplates();var e=$("#templates-ctn"),i=$("#template-images");e.html(""),i.html("");var o=$("<div>").addClass("menu-section-content").appendTo($("<div>").addClass("menu-section-content-ctn").appendTo(e));if($("<div>").addClass("warp-info template add").html('<span class="warp-title"><i class="fa fa-plus"></i></span>').click(this.addTemplateClicked.bind(this)).appendTo(o),this.templates.length>0)this.templates.forEach(function(e,a){var n=$("<div>").addClass("warp-info template").attr("data-template-id",a).attr("title","Jump to the position of this template").appendTo(o);n.click(t.moveToTemplateClicked.bind(t,n)),$("<div>").addClass("warp-delete").attr("title","Delete this template").html('<i class="fa fa-minus fa-fw"></i>').click(t.deleteTemplateClicked.bind(t,n)).appendTo(n),$("<div>").addClass("warp-jump-to").attr("title","Move this template to your current position").html('<i class="fa fa-map-pin fa-fw"></i>').click(t.moveTemplateHereClicked.bind(t,n)).appendTo(n),$("<div>").addClass("warp-visibility").attr("title","Change the opacity of this template").html('<i class="fa fa-eye fa-fw"></i>').click(t.changeOpacityOfTemplateClicked.bind(t,n)).appendTo(n),$("<div>").addClass("warp-scale").attr("title","Change the scale of this template").html('<i class="fa fa-expand fa-fw"></i>').click(t.changeScaleOfTemplateClicked.bind(t,n)).appendTo(n),$("<div>").addClass("template-img").css("background-image","url("+e.url+")").appendTo(n);var s=(e.scale||1)/4;$("<img>").attr("src",e.url).css({top:e.pos.y,left:e.pos.x,transform:"scale("+s+") translateZ(0) translate(-"+50/s+"%, -"+50/s+"%)",opacity:e.opacity}).appendTo(i)});else{o.addClass("empty");var a=$("<div>").addClass("warp-info template explanation").appendTo(o);$("<span>").addClass("warp-title").text("Templates").appendTo(a),$("<span>").addClass("warp-coordinates").text("Overlay an image on the canvas to use as a guide for your art.").appendTo(a)}},addTemplateClicked:function(){var t=this;$("<input>").attr("type","file").attr("accept",".png,.jpg,.gif,.jpeg,.webm,.apng,.svg").hide().on("change",function(){if(this.remove(),this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){var i=e.target.result;t.templates.push({pos:t.getCoordinates(),url:i,opacity:.5,scale:1}),t.layoutTemplates(),t.saveTemplates()},e.onerror=function(t){console.error("Error trying to read template image.",t),alert("An error occurred while attempting to read your template image.")},e.readAsDataURL(this.files[0])}}).appendTo($("body")).click()},deleteTemplateClicked:function(t,e){if(e.preventDefault(),e.stopPropagation(),window.confirm("Are you sure you want to delete this template?")){var i=$(t).attr("data-template-id");!i||i<0||(this.templates.splice(i,1),this.layoutTemplates(),this.saveTemplates())}},moveTemplateHereClicked:function(t,e){e.preventDefault(),e.stopPropagation();var i=$(t).attr("data-template-id");!i||i<0||(this.templates[i].pos=this.getCoordinates(),this.layoutTemplates(),this.saveTemplates())},changeOpacityOfTemplateClicked:function(t,e){e.preventDefault(),e.stopPropagation();var i=$(t).attr("data-template-id");if(i&&!(i<0)){var o=window.prompt("Enter the new desired opacity for this template (as a percentage):",100*(this.templates[i].opacity||.5));if(o){if(o>100||o<0)return window.alert("You must enter a value between 0 and 100.");this.templates[i].opacity=o/100,this.layoutTemplates(),this.saveTemplates()}}},changeScaleOfTemplateClicked:function(t,e){e.preventDefault(),e.stopPropagation();var i=$(t).attr("data-template-id");if(i&&!(i<0)){var o=window.prompt("Enter the new desired scale for this template (relative to 1):",this.templates[i].scale||1);o&&(this.templates[i].scale=o,this.layoutTemplates(),this.saveTemplates())}},moveToTemplateClicked:function(t,e){e.preventDefault(),e.stopPropagation();var i=$(t).attr("data-template-id");if(i&&!(i<0)){var o=this.templates[i].pos;this.zoomIntoPoint(o.x,o.y,!1)}}};place.start($("canvas#place-canvas-draw")[0],$("#zoom-controller")[0],$("#camera-controller")[0],$("canvas#place-canvas")[0],$("#palette")[0],$("#coordinates")[0],$("#user-count")[0],$("#grid-hint")[0],$("#pixel-data-ctn")[0],$("#grid")[0]),place.setZoomButton($("#zoom-button")[0]),place.setGridButton($("#grid-button")[0]),place.setCoordinatesButton($("#coordinates")[0]),$(".popout-control").click(function(){place.popoutController.popoutVisibilityController.open(),place.popoutController.popoutVisibilityController.changeTab($(this).data("tab-name"))}),$("#user-count").click(function(){place.popoutController.popoutVisibilityController.open(),place.popoutController.popoutVisibilityController.changeTab("active-users")});var hash=hashHandler.getHash(),hashKeys=Object.keys(hash);if(hashKeys.indexOf("signin")>0||hashKeys.indexOf("logintext")>0?(hashKeys.indexOf("logintext")>0&&(SignInDialogController.showErrorOnTab("sign-in",hash.logintext),hashHandler.deleteHashKey("logintext")),SignInDialogController.show("sign-in"),hashHandler.deleteHashKey("signin")):hashKeys.indexOf("signup")>0&&(SignInDialogController.show("sign-up"),hashHandler.deleteHashKey("signup")),$("*[data-place-trigger]").click(function(){var t=$(this).data("place-trigger");"openSignInDialog"==t?SignInDialogController.show("sign-in"):"openSignUpDialog"==t?SignInDialogController.show("sign-up"):"openAuthDialog"==t&&SignInDialogController.show()}),place.isSignedIn()){var changelogController={contentElement:$("#changelog-content"),changelogs:null,pagination:null,isLoadingChangelogs:!1,setup:function(){var t=this;return $(document).on("keydown",function(e){var i=37==e.keyCode,o=39==e.keyCode;ChangelogDialogController.isShowing()&&(i||o)&&t.pagination&&(e.preventDefault(),t.pagination.next&&o&&t.requestChangelogPage(t.pagination.next),t.pagination.previous&&i&&t.requestChangelogPage(t.pagination.previous))}),$("#nav-whats-new > a").click(function(){t.getChangelogsForShow("latest")}),this},getChangelogsForShow:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"missed";this.isLoadingChangelogs||(this.isLoadingChangelogs=!0,placeAjax.get("/api/changelog/"+e,null,null,function(){t.isLoadingChangelogs=!1}).then(function(e){placeAjax.post("/api/changelog/missed"),!e.changelogs&&e.changelog&&(e.changelogs=[e.changelog]),t.changelogs=e.changelogs,t.pagination=e.pagination,t.layoutChangelogs(),t.changelogs&&t.changelogs.length>0&&t.showDialog()}).catch(function(t){return console.warn("Couldn't load changelogs: "+t)}))},requestChangelogPage:function(t){var e=this;this.isLoadingChangelogs||(this.isLoadingChangelogs=!0,placeAjax.get("/api/changelog/"+t,null,null,function(){e.isLoadingChangelogs=!1}).then(function(t){t.changelog?e.changelogs=[t.changelog]:e.changelogs=[],e.pagination=t.pagination,e.layoutChangelogs()}).catch(function(e){return console.warn("Couldn't load changelog with ID:"+t+", error: "+e)}))},showDialog:function(){ChangelogDialogController.show()},layoutChangelogs:function(){var t=this;if(!this.changelogs)return this.contentElement.addClass("needs-margin").text("Loading…");if(this.changelogs.length<=0)return this.contentElement.addClass("needs-margin").text("There's no changelog to show.");if(this.contentElement.html("").removeClass("needs-margin"),this.changelogs.forEach(function(e){var i=$("<div>").addClass("changelog-info").attr("data-changelog-version",e.version).appendTo(t.contentElement);$("<p>").addClass("subhead extra-margin").text(t.getFormattedDate(e.date)).appendTo(i),$("<p>").html(e.html).appendTo(i)}),this.pagination){var e=$("<ul>").addClass("pager").appendTo($("<nav>").attr("aria-label","Changelog page navigation").appendTo(this.contentElement)),i=$("<a>").html('<span aria-hidden="true">&larr;</span> Older').appendTo($("<li>").addClass("previous").appendTo(e)),o=$("<a>").html('Newer <span aria-hidden="true">&rarr;</span>').appendTo($("<li>").addClass("next").appendTo(e));this.pagination.previous?i.attr("href","javascript:void(0)").click(function(){return t.requestChangelogPage(t.pagination.previous)}):i.parent().addClass("disabled"),this.pagination.next?o.attr("href","javascript:void(0)").click(function(){return t.requestChangelogPage(t.pagination.next)}):o.parent().addClass("disabled")}},getFormattedDate:function(t){var e=new Date(t),i=(new Date,new Date);return i.setDate(i.getDate()-1),e.toDateString()==(new Date).toDateString()?"Today":e.toDateString()==i.toDateString()?"Yesterday":e.toLocaleDateString()}}.setup();$(document).ready(function(){changelogController.getChangelogsForShow()})}$(document).ready(function(){null!=hashHandler.getHash().beta&&(hashHandler.deleteHashKey("beta"),BetaDialogController.show())}),$("#nav-help > a").click(function(){return HelpDialogController.show()});
